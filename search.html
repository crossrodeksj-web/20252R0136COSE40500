<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>KU Yearbook - ê²€ìƒ‰</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f4f6fa;
      margin: 0;
      padding: 0;
    }

    /* âœ… ìƒë‹¨ë°” (profileê³¼ ë™ì¼) */
    .header {
      background-color: #7a0019;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 50px;
      border-bottom: 2px solid #5c0014;
      white-space: nowrap;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 50px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 30px;
      font-size: 15px;
    }

    .nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }

    .nav a:hover {
      text-decoration: underline;
    }

    .header-right {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      flex: 1;
    }

    .logout-btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      background-color: transparent;
      color: white;
      border: 1px solid white;
      border-radius: 5px;
      padding: 4px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: auto;
      position: relative;
    }

    .logout-btn:hover {
      background-color: rgba(255, 255, 255, 0.25);
    }

    /* âœ… ê²€ìƒ‰ ì˜ì—­ */
    .container {
      width: 80%;
      margin: 40px auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h2 {
      color: #004aad;
      margin-bottom: 20px;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    button.search-btn {
      background-color: #004aad;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 15px;
      cursor: pointer;
      font-weight: 600;
    }

    button.search-btn:hover {
      background-color: #003a8b;
    }

    /* âœ… ê²°ê³¼ ì¸ë„¤ì¼ */
    .results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 6px;
    }

    .card h3 {
      margin: 8px 0 4px;
      font-size: 16px;
    }

    .card p {
      font-size: 13px;
      color: #666;
      margin: 3px 0;
    }

    .tags {
      margin-top: 5px;
    }

    .tag {
      display: inline-block;
      background-color: #e3f2fd;
      color: #004aad;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 4px;
    }

    .no-results {
      color: #777;
      font-size: 15px;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <!-- âœ… ìƒë‹¨ë°” -->
  <div class="header">
    <div class="header-left">
      <div class="logo" onclick="location.href='home.html'">KU Yearbook</div>
      <div class="nav">
        <a href="home.html">ë‚´ í”„ë¡œí•„</a>
        <a href="search.html">ê²€ìƒ‰</a>
        <a href="dashboard.html">ëŒ€ì‹œë³´ë“œ</a>
      </div>
    </div>
    <div class="header-right">
      <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- âœ… ê²€ìƒ‰ ë³¸ë¬¸ -->
  <div class="container">
    <h2>ğŸ” ì‚¬ì§„ / ì˜ìƒ ê²€ìƒ‰</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="ì œëª©ì´ë‚˜ íƒœê·¸(#)ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: #ì—¬í–‰, ê³ ì–‘ì´">
      <button class="search-btn" onclick="search()">ê²€ìƒ‰</button>
      <!-- ğŸ¤ ê°€ì§œ ASR ë²„íŠ¼ ì¶”ê°€ -->
      <button type="button" onclick="startVoiceSearchFake()">ğŸ¤</button>
    </div>
    <!-- ASR ìƒíƒœ ë©”ì‹œì§€ ì˜ì—­ ì¶”ê°€ -->
    <p id="asrStatus" style="font-size:13px;color:#777;margin-top:4px;"></p>

    <div id="suggestedTags" style="font-size:13px; color:#555; margin-top:4px;"></div>

    <div id="results" class="results"></div>

    <p id="noResults" class="no-results" style="display:none;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  </div>

  <script>
    function logout() {
      localStorage.removeItem("userProfile");
      location.href = "login.html";
    }

    // âœ… localStorageì—ì„œ ì—…ë¡œë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        // âœ… localStorageì—ì„œ ì—…ë¡œë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const uploads = JSON.parse(localStorage.getItem("uploads") || "[]");
    const resultsDiv = document.getElementById("results");
    const noResults = document.getElementById("noResults");

    /* ------------------------------
       ASR + NLU ì‹œë®¬ë ˆì´ì…˜ìš© í‚¤ì›Œë“œ ê·œì¹™
       - ì¸ì‹ëœ ë¬¸ì¥ì—ì„œ ê²€ìƒ‰ì— ìœ ìš©í•œ ë‹¨ì–´ë¥¼ ë½‘ëŠ” ìš©ë„
    ------------------------------ */
    const ASR_KEYWORDS = [
      "ì¶•ì œ",
      "ë™ì•„ë¦¬",
      "ì— í‹°",
      "MT",
      "ë™ë¬¼"
    ];

    // ì¸ì‹ëœ ë¬¸ì¥ì—ì„œ ìœ„ í‚¤ì›Œë“œë“¤ë§Œ ë½‘ì•„ë‚´ëŠ” ê°„ë‹¨í•œ NLU í•¨ìˆ˜
    function extractKeywordsFromSentence(sentence) {
      const text = sentence.toLowerCase();
      const found = [];

      ASR_KEYWORDS.forEach(keyword => {
        if (text.includes(keyword.toLowerCase())) {
          found.push(keyword);
        }
      });

      return found;
    }

    /* ------------------------------
       ASR (ê°€ì§œ): ìŒì„± ê²€ìƒ‰ ì‹œë®¬ë ˆì´ì…˜
       - 1) "ìŒì„± ì¸ì‹ ì¤‘..." ìƒíƒœ í‘œì‹œ
       - 2) ì˜ˆì‹œ ë¬¸ì¥ì„ ì¸ì‹í•œ ê²ƒì²˜ëŸ¼ ë§Œë“¤ê³ 
       - 3) í‚¤ì›Œë“œ ì¶”ì¶œ í›„ ê²€ìƒ‰ì–´ë¡œ ì‚¬ìš©
    ------------------------------ */
    function startVoiceSearchFake() {
      const input = document.getElementById("searchInput");
      const status = document.getElementById("asrStatus");
      if (!input) return;

      // 1) ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      if (status) {
        status.innerText = 'ìŒì„± ì¸ì‹ ì¤‘... (ì‹œë®¬ë ˆì´ì…˜)';
      }

      // 2) 1ì´ˆ ë’¤ì— "ì¸ì‹ ê²°ê³¼"ê°€ ë‚˜ì˜¨ ê²ƒì²˜ëŸ¼ ì²˜ë¦¬
      setTimeout(() => {
        const recognizedSentence = "ë™ë¬¼ ì‚¬ì§„ ì°¾ì•„ì¤˜";

        // 3) ê·œì¹™ ê¸°ë°˜ NLUë¡œ í‚¤ì›Œë“œ ì¶”ì¶œ
        const keywords = extractKeywordsFromSentence(recognizedSentence);

        // ê²€ìƒ‰ì— ì‹¤ì œë¡œ ì‚¬ìš©í•  query ê²°ì •
        // - í‚¤ì›Œë“œê°€ í•˜ë‚˜ ì´ìƒ ìˆìœ¼ë©´ ì²« ë²ˆì§¸ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©
        // - ì—†ìœ¼ë©´ ì „ì²´ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const queryForSearch = keywords.length > 0 ? keywords[0] : recognizedSentence;

        // ì¸ì‹ëœ ë¬¸ì¥ê³¼ ì‹¤ì œ ê²€ìƒ‰ì–´ë¥¼ ìƒíƒœ ë©”ì‹œì§€ë¡œ ë³´ì—¬ì£¼ê¸° (HCI ê´€ì ì—ì„œ ì¢‹ìŒ)
        if (status) {
          status.innerText =
            `ì¸ì‹ëœ ë¬¸ì¥: "${recognizedSentence}"  â†’ ê²€ìƒ‰ì–´: "${queryForSearch}"`;
        } else {
          // í˜¹ì‹œ status ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì—†ìœ¼ë©´ alertë¼ë„
          alert(`ì¸ì‹ëœ ë¬¸ì¥: "${recognizedSentence}"\nê²€ìƒ‰ì–´: "${queryForSearch}"`);
        }

        // 4) ê²€ìƒ‰ì°½ì— ê²€ìƒ‰ì–´ ì±„ì›Œ ë„£ê³  search() ì‹¤í–‰
        input.value = queryForSearch;
        search();

      }, 1000);
    }

        /* ------------------------------
       NLU: ì¶”ì²œ íƒœê·¸ ê·œì¹™
       - ê²€ìƒ‰ì–´ì™€ ì˜ë¯¸ì ìœ¼ë¡œ ì—°ê´€ëœ íƒœê·¸ë¥¼ ì œì•ˆ
    ------------------------------ */
    const RELATED_TAGS = {
      "ì¶•ì œ": ["#ê³µì—°", "#ë¶€ìŠ¤", "#ì…ì‹¤ë Œí‹°"],
      "ë™ë¬¼": ["#í˜¸ë‘ì´", "#ê³ ì–‘ì´"]
      // í•„ìš”í•˜ë©´ ì—¬ê¸° í‚¤ì›Œë“œ/íƒœê·¸ ë” ì¶”ê°€
    };

    // ê²€ìƒ‰ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œ íƒœê·¸ë¥¼ í™”ë©´ì— í‘œì‹œ
    function showSuggestedTags(rawQuery) {
      const box = document.getElementById("suggestedTags");
      if (!box) return;

      const trimmed = (rawQuery || "").trim();
      const q = trimmed.replace(/^#/, ""); // ì•ì— # ë¶™ì˜€ìœ¼ë©´ ì œê±°
      if (!q) {
        box.innerHTML = "";
        return;
      }

      let suggestions = [];

      // 1ìˆœìœ„: ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í‚¤
      if (RELATED_TAGS[q]) {
        suggestions = RELATED_TAGS[q];
      } else {
        // 2ìˆœìœ„: ë¶€ë¶„ ì¼ì¹˜ í‚¤ì›Œë“œë“¤ë„ ê²€ìƒ‰
        const lower = q.toLowerCase();
        Object.keys(RELATED_TAGS).forEach(key => {
          if (key.toLowerCase().includes(lower)) {
            suggestions = suggestions.concat(RELATED_TAGS[key]);
          }
        });
      }

      if (suggestions.length === 0) {
        box.innerHTML = "";
        return;
      }

      // ì¤‘ë³µ ì œê±°
      const unique = Array.from(new Set(suggestions));

      box.innerHTML =
        `<span style="font-weight:600; margin-right:6px;">ì¶”ì²œ íƒœê·¸:</span>` +
        unique
          .map(tag => `
            <button type="button"
                    class="tag"
                    style="margin-top:4px; cursor:pointer; border:none; border-radius:12px; padding:4px 10px;">
              ${tag}
            </button>
          `)
          .join(" ");

      // ê° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
      const buttons = box.querySelectorAll("button.tag");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const t = btn.textContent.trim();
          useSuggestedTag(t);
        });
      });
    }

    // ì¶”ì²œ íƒœê·¸ë¥¼ í´ë¦­í•˜ë©´ ê·¸ íƒœê·¸ë¡œ ë‹¤ì‹œ ê²€ìƒ‰
    function useSuggestedTag(tag) {
      const input = document.getElementById("searchInput");
      if (!input) return;
      input.value = tag;
      search();
    }


    function search() {
      // ì›ë³¸ ê²€ìƒ‰ì–´(ëŒ€ì†Œë¬¸ì ìœ ì§€)ì™€ ì†Œë¬¸ì ë²„ì „ ë¶„ë¦¬
      const rawQuery = document.getElementById("searchInput").value.trim();
      const query = rawQuery.toLowerCase();
      resultsDiv.innerHTML = "";

      // âœ… NLU: ì¶”ì²œ íƒœê·¸ í‘œì‹œ
      showSuggestedTags(rawQuery);

      if (!query) {
        noResults.style.display = "none";
        return;
      }

      // ì œëª© ë˜ëŠ” íƒœê·¸ì—ì„œ ê²€ìƒ‰
      const filtered = uploads.filter(item =>
        item.title.toLowerCase().includes(query) ||
        (item.tags && item.tags.some(tag => tag.toLowerCase().includes(query.replace("#", ""))))
      );


      if (filtered.length === 0) {
        noResults.style.display = "block";
        return;
      }

      noResults.style.display = "none";
      filtered.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        // ğŸ“Œ ì‚¬ì§„ / ì˜ìƒ ë¶„ê¸°
        const preview = item.type === "video"
          ? `
              <video 
                src="${item.url}" 
                controls
                muted
                playsinline
                preload="metadata"
                style="width:100%; height:180px; border-radius:6px; object-fit:cover;">
              </video>
            `
          : `<img src="${item.url}" alt="${item.title}">`;


        card.innerHTML = `
          ${preview}
          <h3>${item.title}</h3>
          <p>${item.place}</p>
          <div class="tags">
            ${(item.tags || []).map(tag => `<span class='tag'>#${tag}</span>`).join(" ")}
          </div>
          <button type="button" onclick="readSearchCard(this)" style="margin-top:6px;">ğŸ”Š</button>
          <p style="font-size:12px;color:#999;">${item.time || ""}</p>
        `;
        resultsDiv.appendChild(card);
      });

    }

    /* ------------------------------
       TTS: ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œ ì½ê¸°
    ------------------------------ */
    function readSearchCard(buttonEl) {
      const card = buttonEl.closest('.card');
      if (!card) return;

      const title = card.querySelector('h3')?.innerText || 'ì œëª© ì—†ìŒ';

      // ì²« ë²ˆì§¸ <p>ê°€ ì¥ì†Œ, ë‘ ë²ˆì§¸ <p>ëŠ” ì‹œê°„
      const placeP = card.querySelector('p');
      const place = placeP ? placeP.innerText : '';

      const tagSpans = card.querySelectorAll('.tags .tag');
      const tags = Array.from(tagSpans).map(span =>
        (span.innerText || '').replace(/^#/, '')
      );

      const placeSentence = place ? `ì´¬ì˜ ì¥ì†ŒëŠ” ${place}ì…ë‹ˆë‹¤.` : '';
      const tagsSentence = tags.length > 0
        ? `íƒœê·¸ëŠ” ${tags.join(", ")} ì…ë‹ˆë‹¤.`
        : '';

      const text = `${title}. ${placeSentence} ${tagsSentence}`.trim();
      speakText(text);
    }
  </script>


  <!-- TTS ê³µí†µ í•¨ìˆ˜ -->
  <script>
    function speakText(text) {
      if (!('speechSynthesis' in window)) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¶œë ¥(TTS)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      // ì´ì „ì— ì½ë˜ ê±° ìˆìœ¼ë©´ ì •ì§€
      window.speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ko-KR'; // í•œêµ­ì–´
      window.speechSynthesis.speak(utter);
    }
  </script>

</body>
</html>
